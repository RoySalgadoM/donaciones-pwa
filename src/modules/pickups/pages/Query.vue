<template>
  <ContentSection>
    <template #title> Recolecciones </template>
    <template #contentOptions>
      <Input
        noWhiteSpace
        :label="'Buscar...'"
        v-model="filter"
        @clean="
          () => {
            handleSearchInput();
            filter = null;
          }
        "
        @update:modelValue="handleSearchInput"
      />
      <div class="ml-4">
        <Btn
          type="submit"
          color="bg-primary"
          hoverColor="hover:bg-primary"
          rounded
        >
          <template #icon>
            <div class="flex justify-center" @click="modalAdd = true">
              <span class="material-icons"> local_shipping </span>
            </div>
          </template>
        </Btn>
      </div>
    </template>
    <template #content>
      <div v-if="stores.length === 0">
        <div class="flex justify-center">
          <div class="mt-10 mb-5 text-gray-500 text-2xl">
            No hay recolecciones registradas
          </div>
        </div>
      </div>

      <div
        v-if="stores.length > 0"
        class="grid grid-cols-12 gap-4 px-2 items-stretch"
      >
        <Collapse v-for="store in stores" :key="store.id">
          <template #content>
            <div
              class="bg-white p-2 shadow-md flex flex-col rounded-lg rounded-collapse-top"
            >
              <div
                class="flex flex-row shrink-0 mr-2 items-center justify-center"
              >
                <span
                  class="material-icons text-primary"
                  style="font-size: 4rem"
                  >local_shipping</span
                >
                <div class="ml-2 flex-grow min-w-0">
                  <div class="font-semibold break-words truncate">
                    {{ store.name }}
                  </div>
                  <div class="text-gray-600 break-words truncate">
                    {{ "Responsable: " + store.nameLinkPerson }}
                  </div>
                  <span
                    v-if="store.status"
                    class="bg-green-200 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded dark:bg-green-200 dark:text-green-900"
                  >
                    Activo
                  </span>
                  <span
                    v-else
                    class="bg-red-200 text-red-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded dark:bg-red-200 dark:text-red-900"
                  >
                    Inactivo
                  </span>
                </div>
              </div>

              <div
                class="flex-shrink-0 flex justify-end items-end space-x-2 buttons-container"
              >
                <Btn
                  color="bg-gray-200"
                  hoverColor="hover:bg-gray-200"
                  rounded
                  @click="showModalEdit(store)"
                >
                  <template #icon>
                    <span class="material-icons">edit</span>
                  </template>
                </Btn>
                <Btn
                  type="submit"
                  color="bg-gray-200"
                  hoverColor="hover:bg-gray-200"
                  rounded
                  @click="selectedRow(store)"
                >
                  <template #icon>
                    <span class="material-icons">info</span>
                  </template>
                </Btn>
                <Btn
                  v-if="store.status"
                  type="submit"
                  color="bg-gray-200"
                  hoverColor="hover:bg-gray-200"
                  rounded
                  @click="handleChangeStatus(store.id, store.status)"
                >
                  <template #icon>
                    <span class="material-icons">close</span>
                  </template>
                </Btn>
                <Btn
                  v-else
                  type="submit"
                  color="bg-gray-200"
                  hoverColor="hover:bg-gray-200"
                  rounded
                  @click="handleChangeStatus(store.id, store.status)"
                >
                  <template #icon>
                    <span class="material-icons">done</span>
                  </template>
                </Btn>
              </div>
            </div>
          </template>
          <template #contentCollapse>
            <div
              class="bg-white pr-4 pb-4 shadow-md flex justify-end rounded-collapse-bottom hide-options"
            >
              <div class="flex-shrink-0 flex space-x-2">
                <Btn
                  color="bg-gray-200"
                  hoverColor="hover:bg-gray-200"
                  rounded
                  @click="showModalEdit(store)"
                >
                  <template #icon>
                    <span class="material-icons">edit</span>
                  </template>
                </Btn>
                <Btn
                  type="submit"
                  color="bg-gray-200"
                  hoverColor="hover:bg-gray-200"
                  rounded
                  @click="selectedRow(store)"
                >
                  <template #icon>
                    <span class="material-icons">info</span>
                  </template>
                </Btn>
                <Btn
                  v-if="store.status"
                  type="submit"
                  color="bg-gray-200"
                  hoverColor="hover:bg-gray-200"
                  rounded
                  @click="handleChangeStatus(store.id, store.status)"
                >
                  <template #icon>
                    <span class="material-icons">close</span>
                  </template>
                </Btn>
                <Btn
                  v-else
                  type="submit"
                  color="bg-gray-200"
                  hoverColor="hover:bg-gray-200"
                  rounded
                  @click="handleChangeStatus(store.id, store.status)"
                >
                  <template #icon>
                    <span class="material-icons">done</span>
                  </template>
                </Btn>
              </div>
            </div>
          </template>
        </Collapse>
      </div>
    </template>
  </ContentSection>

  <!-- Modal para agregar recolecci贸n -->
  <Dialog :size="sm" :show="modalAdd" @update:show="modalAdd = $event">
    <template #title>
      <div class="flex justify-center">
        <h2 class="text-2xl font-bold text-black">Agregar recolecci贸n</h2>
      </div>
    </template>
    <template #content>
      <div class="flex items-center">
        <Form class="pt-5 mb-4" @formSubmit="handleAdd">
          <div class="flex flex-col gap-4">
            <div class="mb-4">
              <Input
                required
                :label="'Nombre'"
                v-model.alfa="pickup.name"
                @clean="pickup.name = null"
              />
            </div>
          </div>
          <div class="flex flex-col sm:grid sm:grid-cols-12 sm:gap-4">
            <div class="mb-4 sm:col-span-6">
              <Select
                v-model="pickup.chain"
                @clean="pickup.chain = null"
                required
                :label="'Tienda'"
                :options="selectStores"
                :loading="selectStores === null"
              />
            </div>
            <div class="mb-4 sm:col-span-6">
              <Select
                v-model="pickup.user"
                @clean="pickup.user = null"
                required
                :options="selectUsers"
                :loading="selectUsers === null"
                :label="'Empleado'"
              />
            </div>
          </div>
          <span class="mt-3 text-lg font-bold">Productos</span>
          <hr class="bg-primary" />
          <div class="grid grid-cols-12 gap-4 mt-3">
            <div class="mb-4 col-span-8">
              <Select
                v-model="product.value"
                @clean="product.value = null"
                required
                :options="selecProducts"
                :loading="selecProducts === null"
                :label="'Producto'"
              />
            </div>
            <div class="mb-4 col-span-2">
              <Input
                required
                :label="'#'"
                v-model.integer="product.quantity"
                @clean="product.quantity = null"
              />
            </div>
            <div class="mb-4 col-span-2">
              <Btn
                type="submit"
                color="bg-primary"
                hoverColor="hover:bg-primary"
                rounded
              >
                <template #icon>
                  <div class="flex justify-center" @click="modalAdd = true">
                    <span class="material-icons"> local_shipping </span>
                  </div>
                </template>
              </Btn>
            </div>
          </div>
          <div class="flex items-center justify-end gap-2 mt-5">
            <Btn color="bg-primary" hoverColor="hover:bg-primary" rounded>
              <template #icon>
                <span class="material-icons">save</span>
              </template>
            </Btn>
            <Btn
              type="button"
              color="bg-gray-200"
              hoverColor="hover:bg-gray-200"
              rounded
              @click="modalAdd = false"
            >
              <template #icon>
                <span class="material-icons">close</span>
              </template>
            </Btn>
          </div>
        </Form>
      </div>
    </template>
  </Dialog>

  <!-- Modal para editar recolecci贸n -->
  <Dialog :show="modalEdit" @update:show="modalEdit = $event">
    <template #title>
      <div class="flex justify-center">
        <h2 class="text-2xl font-bold text-black">Editar recolecci贸n</h2>
      </div>
    </template>
    <template #content>
      <div class="flex items-center">
        <Form class="pt-5 mb-4" @formSubmit="handleUpdate">
          <div class="flex flex-col gap-4">
            <div class="mb-4">
              <Input
                required
                :label="'Nombre'"
                v-model.alfa="storeEdit.name"
                @clean="storeEdit.name = null"
              />
            </div>
          </div>
          <div class="flex flex-col gap-4">
            <div class="mb-4">
              <Input
                required
                :label="'Persona responsable'"
                v-model.alfa="storeEdit.nameLinkPerson"
                @clean="storeEdit.nameLinkPerson = null"
              />
            </div>
          </div>
          <div class="flex flex-col grid-cols-12 gap-4">
            <div class="mb-4">
              <Input
                required
                :label="'Direcci贸n'"
                v-model.alfa="storeEdit.address"
                @clean="storeEdit.address = null"
              />
            </div>
          </div>
          <div class="flex flex-col sm:flex-row sm:gap-4">
            <div class="mb-4">
              <Input
                required
                noWhiteSpace
                :label="'Tel茅fono'"
                v-model.integer="editPhones.phone"
                @clean="editPhones.phone = null"
                :rules="[
                  (v) => v.length == 10 || 'El tel茅fono debe tener 10 d铆gitos',
                ]"
              />
            </div>
            <div class="mb-4">
              <Input
                noWhiteSpace
                :label="'Tel茅fono respaldo'"
                v-model.integer="editPhones.secondphone"
                @clean="editPhones.secondphone = null"
                :rules="[
                  (v) => v.length == 10 || 'El tel茅fono debe tener 10 d铆gitos',
                ]"
              />
            </div>
          </div>
          <div class="flex items-center justify-end gap-2 mt-5">
            <Btn color="bg-primary" hoverColor="hover:bg-primary" rounded>
              <template #icon>
                <span class="material-icons">save</span>
              </template>
            </Btn>
            <Btn
              type="button"
              color="bg-gray-200"
              hoverColor="hover:bg-gray-200"
              rounded
              @click="modalAdd = false"
            >
              <template #icon>
                <span class="material-icons">close</span>
              </template>
            </Btn>
          </div>
        </Form>
      </div>
    </template>
  </Dialog>

  <!-- Modal para ver informaci贸n recolecci贸n -->
  <Dialog :show="modalInfo" @update:show="modalInfo = $event">
    <template #title>
      <div class="flex justify-center">
        <h2 class="text-2xl font-bold text-gray-900">
          Informaci贸n de recolecci贸n
        </h2>
      </div>
    </template>
    <template #content>
      <div
        class="grid grid-cols-12 items-center justify-center w-5/6 gap-6 mt-5 mb-5"
      >
        <div class="col-span-12 sm:col-span-6 mb-1">
          <div class="flex flex-col flex-grow">
            <label class="text-primary text-sm font-title">Nombre</label>
            <label class="text-black dark:text-white text-lg font-title">{{
              storeEdit ? storeEdit.name : "Nombre"
            }}</label>
          </div>
        </div>
        <div class="col-span-12 sm:col-span-6 mb-1">
          <div class="flex flex-col flex-grow">
            <label class="text-primary text-sm font-title"
              >Nombre del responsable</label
            >
            <label class="text-black dark:text-white text-lg font-title">{{
              storeEdit ? storeEdit.nameLinkPerson : "Responsable"
            }}</label>
          </div>
        </div>
        <div class="col-span-12 mb-1">
          <div class="flex flex-col flex-grow">
            <label class="text-primary text-sm font-title">Direcci贸n</label>
            <label class="text-black dark:text-white text-lg font-title">{{
              storeEdit ? storeEdit.address : "Direcci贸n"
            }}</label>
          </div>
        </div>
        <div class="col-span-12 sm:col-span-6 mb-1">
          <div class="flex flex-col flex-grow">
            <label class="text-primary text-sm font-title">Tel茅fonos</label>
            <label
              v-for="phone in storeEdit.phones"
              :key="phone"
              class="text-black dark:text-white text-lg font-title"
            >
              {{ phone }}</label
            >
          </div>
        </div>
        <div class="col-span-12 sm:col-span-6 mb-1">
          <div class="flex flex-col flex-grow">
            <label class="text-primary text-sm font-title">Estado</label>
            <label class="text-black dark:text-white text-lg font-title">{{
              storeEdit ? (storeEdit.status ? "Activo" : "Inactivo") : "Estado"
            }}</label>
          </div>
        </div>
      </div>
    </template>
  </Dialog>
</template>
      
    <script setup>
import { inject, ref, onMounted } from "vue";
import { useStoresStore } from "@/modules/stores/stores/store";
import { useUsersStore } from "@/modules/employees/stores/user";
import { useProductsStore } from "@/modules/products/stores/product";
import { storeToRefs } from "pinia";

const showMsg = inject("showMsg", () => {});
const timeout = ref(null);
const filter = ref("");
const modalAdd = ref(false);
const modalEdit = ref(false);
const modalInfo = ref(false);
const storesStore = useStoresStore();
const usersStore = useUsersStore();
const productsStore = useProductsStore();
const { stores } = storeToRefs(storesStore);

//selects
const selectStores = ref(false);
const selectUsers = ref(false);
const selecProducts = ref(false);

const pag = ref({
  rowsPerPage: 100,
  page: 1,
});

const store = ref({
  name: null,
  address: null,
  nameLinkPerson: null,
  phones: [],
});

const phones = ref({
  phone: null,
  secondphone: null,
});

const storeEdit = ref({
  id: null,
  name: null,
  address: null,
  nameLinkPerson: null,
  phones: [],
});

const editPhones = ref({
  phone: null,
  secondphone: null,
});

const pickup = ref({
  name: null,
  chain: null,
  user: null,
  products: [],
});

const product = ref({
  value: null,
  quantity: null,
});

const handleStores = async () => {
  try {
    let payload = {
      query: {
        filter: filter.value,
        ...pag.value,
      },
    };
    let res = await storesStore.getStores(payload);
  } catch (error) {
    if (error.code == "ERR_NETWORK") {
      showMsg("error", "Error de conexi贸n");
    } else {
      console.log(error);
      showMsg("error", "Error interno del servidor");
    }
  }
};

const showStores = async () => {
  try {
    let payload = {
      query: {
        ...pag.value,
      },
    };
    let res = await storesStore.getStores(payload);
    console.log(res);
    if (res.chains) {
      selectStores.value = res.chains.map((item) => {
        return {
          label: item.name,
          value: item.id,
        };
      });
    }
  } catch (error) {
    if (error.code == "ERR_NETWORK") {
      showMsg("error", "Error de conexi贸n");
    } else {
      console.log(error);
      showMsg("error", "Error interno del servidor");
    }
  }
};

const showUsers = async () => {
  try {
    let payload = {
      query: {
        ...pag.value,
      },
    };
    let res = await usersStore.getUsers(payload);
    console.log(res);
    if (res.users) {
      selectUsers.value = res.users.map((item) => {
        return {
          label: item.name + " " + item.lastname + " " + item.secondSurname,
          value: item.id,
        };
      });
    }
  } catch (error) {
    if (error.code == "ERR_NETWORK") {
      showMsg("error", "Error de conexi贸n");
    } else {
      console.log(error);
      showMsg("error", "Error interno del servidor");
    }
  }
};

const showProducts = async () => {
  try {
    let payload = {
      query: {
        ...pag.value,
      },
    };
    let res = await productsStore.getProducts(payload);
    console.log(res);
    if (res.products) {
      selecProducts.value = res.products.map((item) => {
        return {
          label: item.name,
          value: item.id,
        };
      });
    }
  } catch (error) {
    if (error.code == "ERR_NETWORK") {
      showMsg("error", "Error de conexi贸n");
    } else {
      console.log(error);
      showMsg("error", "Error interno del servidor");
    }
  }
};

const handleSearchInput = async (props) => {
  try {
    clearTimeout(timeout.value);
    timeout.value = setTimeout(async () => {
      handleStores();
    }, 900);
  } catch (error) {
    showMsg("error", error);
  }
};

const handleAdd = async () => {
  try {
    let aux = [phones.value.phone];
    if (phones.value.secondphone != null) {
      aux.push(phones.value.secondphone);
    }
    let payload = {
      body: {
        ...store.value,
        phones: aux,
      },
    };
    console.log(payload);
    let res = await storesStore.addStore(payload);
    if (res.data.statusCode == 200) {
      showMsg("success", "Tienda agregada correctamente");
      modalAdd.value = false;
      store.value = {
        name: null,
        address: null,
        nameLinkPerson: null,
        status: null,
        phones: [],
      };
      phones.value = {
        phone: null,
        secondphone: null,
      };
      handleStores();
    }
  } catch (error) {
    if (error.code == "ERR_NETWORK") {
      showMsg("error", "Error de conexi贸n");
    } else if (error.code == "ERR_BAD_REQUEST") {
      showMsg("error", error.response.data.message);
    } else {
      console.error(error);
      showMsg("error", "Error interno del servidor");
    }
  }
};

const showModalEdit = async (store) => {
  try {
    storeEdit.value = {
      id: store.id,
      name: store.name,
      address: store.address,
      nameLinkPerson: store.nameLinkPerson,
      phones: [],
    };
    editPhones.value = {
      phone: store.phones[0],
      secondphone: store.phones[1] ? store.phones[1] : null,
    };
    modalEdit.value = true;
  } catch (error) {
    console.error(error);
  }
};

const handleUpdate = async () => {
  try {
    let aux = [editPhones.value.phone];
    if (editPhones.value.secondphone != null) {
      aux.push(editPhones.value.secondphone);
    }
    let payload = {
      id: storeEdit.value.id,
      body: {
        name: storeEdit.value.name,
        address: storeEdit.value.address,
        nameLinkPerson: storeEdit.value.nameLinkPerson,
        phones: aux,
      },
    };
    console.log(payload);
    let res = await storesStore.updateStore(payload);
    if (res.data.statusCode == 200) {
      showMsg("success", "Tienda actualizada correctamente");
      modalEdit.value = false;
      handleStores();
    }
  } catch (error) {
    if (error.code == "ERR_NETWORK") {
      showMsg("error", "Error de conexi贸n");
    } else if (error.code == "ERR_BAD_REQUEST") {
      showMsg("error", error.response.data.message);
    } else {
      console.error(error);
      showMsg("error", "Error interno del servidor");
    }
  }
};

const handleChangeStatus = async (id, status) => {
  try {
    let res = await storesStore.changeStatus(id, !status);
    if (res.data.statusCode == 200) {
      showMsg("success", "Estado actualizado correctamente");
      handleStores();
    }
  } catch (error) {
    if (error.code == "ERR_NETWORK") {
      showMsg("error", "Error de conexi贸n");
    } else if (error.code == "ERR_BAD_REQUEST") {
      showMsg("error", error.response.data.message);
    } else {
      console.error(error);
      showMsg("error", "Error interno del servidor");
    }
  }
};

const selectedRow = async (store) => {
  try {
    storeEdit.value = {
      id: store.id,
      name: store.name,
      address: store.address,
      nameLinkPerson: store.nameLinkPerson,
      status: store.status,
      phones: store.phones,
    };
    modalInfo.value = true;
  } catch (error) {
    console.log(error);
  }
};

onMounted(() => {
  handleStores();
  showStores();
  showUsers();
  showProducts();
});
</script>